<!--
settings.html (updated)
Branch: image_cropping

This version keeps all JavaScript and CSS inline (no bootstrap or external CSS/JS),
and uses the provided cropper.js at /static/scripts/cropper.js.

Behavior:
- Adds a "Set Crop" button per image that opens a modal with cropper.js UI.
- On Apply, saves crop settings (JSON) into hidden input named crop_settings[<id>].
- Does NOT modify any image files; only saves settings for later processing.
- Shows a small preview thumbnail if cropping can produce a canvas (may fail for cross-origin images).
- Uses simple modal implementation (no external libraries besides cropper.js).
-->

<!-- Include cropper.js (existing script in your repo) -->
<script src="/static/scripts/cropper.js"></script>

<style>
/* Inline CSS for crop UI and modal */

/* Simple modal overlay */
.cropper-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1200;
}

/* Modal dialog */
.cropper-modal {
  width: 95%;
  max-width: 1100px;
  max-height: 90vh;
  background: #fff;
  border-radius: 6px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Modal header/body/footer */
.cropper-modal .cm-header,
.cropper-modal .cm-footer {
  padding: 10px 14px;
  background: #f7f7f7;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.cropper-modal .cm-body {
  padding: 10px 14px;
  overflow: auto;
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

/* Cropper image container */
.cropper-image-wrap {
  flex: 1 1 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  min-width: 200px;
  max-height: 70vh;
  overflow: hidden;
  background: #fafafa;
}

/* Controls column */
.cropper-controls {
  min-width: 260px;
  max-width: 320px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Buttons */
.btn {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 4px;
  border: 1px solid #bbb;
  background: #fff;
  cursor: pointer;
  font-size: 13px;
}
.btn-primary {
  background: #0b63d6;
  color: #fff;
  border-color: #084ea8;
}
.btn-secondary {
  background: #f3f4f6;
}
.btn-group {
  display:flex;
  gap:6px;
}

.cropper-controls label {
  font-size: 13px;
  margin-bottom: 4px;
  color: #333;
}

/* Preview thumbnail */
.crop-preview {
  width: 160px;
  height: auto;
  border: 1px solid #ddd;
  object-fit: cover;
  display: block;
}

/* Close button inline */
.cm-close {
  background: transparent;
  border: none;
  font-size: 20px;
  line-height: 1;
  cursor: pointer;
}

/* Prevent body scroll when modal open */
body.cropper-modal-open {
  overflow: hidden;
}

/* A few minor layout tweaks for image-list item (adjust as necessary to match your app) */
.image-list { display: flex; flex-direction: column; gap: 10px; }
.image-item { display:flex; gap:12px; align-items:center; padding:8px; border:1px solid #eee; border-radius:6px; }
.image-thumb img.upload-list-img { width: 96px; height: auto; border-radius:4px; object-fit:cover; }
.image-meta { display:flex; flex-direction:column; gap:6px; flex:1; }
.crop-preview-wrapper { margin-top:6px; }
</style>

<!-- ... existing HTML above ... -->
<form id="image-upload-settings-form" method="post" action="{{ save_settings_url }}">
  <div class="image-list">
    {% for img in images %}
    <div class="image-item" data-image-id="{{ img.id }}">
      <div class="image-thumb">
        <img src="{{ img.url }}" alt="{{ img.name }}" class="upload-list-img" />
      </div>

      <div class="image-meta">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <strong class="image-name">{{ img.name }}</strong>
            <div style="color:#666; font-size:12px;">ID: {{ img.id }}</div>
          </div>

          <!-- Set Crop button -->
          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button"
                    class="btn btn-secondary btn-set-crop"
                    data-image-id="{{ img.id }}"
                    data-image-src="{{ img.url }}">
              Set Crop
            </button>
          </div>
        </div>

        <!-- Hidden input that will store the crop JSON for this image -->
        <input type="hidden"
               name="crop_settings[{{ img.id }}]"
               id="crop-settings-{{ img.id }}"
               value='{{ img.crop_settings|default("") }}' />

        <!-- Small preview thumbnail of current crop (if any) -->
        <div class="crop-preview-wrapper">
          <img id="crop-preview-{{ img.id }}" class="crop-preview" alt="Crop preview"
               {% if img.crop_settings %} src="{{ img.crop_preview_url|default('') }}" {% endif %}/>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Your existing Save/Submit buttons -->
  <div class="form-actions" style="margin-top:12px;">
    <button type="submit" class="btn btn-primary">Save Settings</button>
  </div>
</form>

<!-- Cropper modal markup (single modal reused for all images) -->
<div id="cropperModalOverlay" class="cropper-modal-overlay" aria-hidden="true">
  <div class="cropper-modal" role="dialog" aria-modal="true" aria-labelledby="cropperModalTitle">
    <div class="cm-header">
      <div id="cropperModalTitle" style="font-weight:600;">Crop Image</div>
      <div>
        <button class="cm-close" id="cropper-close" aria-label="Close">&times;</button>
      </div>
    </div>

    <div class="cm-body">
      <div class="cropper-image-wrap">
        <img id="cropperImage" src="" alt="To crop" style="max-width:100%; max-height:70vh; display:block;">
      </div>

      <div class="cropper-controls">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div style="font-size:13px; font-weight:600;">Controls</div>
          <div style="font-size:12px; color:#666;">Preview</div>
        </div>

        <div class="btn-group" role="group" aria-label="Transform">
          <button type="button" class="btn" id="crop-rotate-left" title="Rotate left">⟲</button>
          <button type="button" class="btn" id="crop-rotate-right" title="Rotate right">⟳</button>
          <button type="button" class="btn" id="crop-reset" title="Reset">Reset</button>
        </div>

        <div>
          <label for="crop-aspect">Aspect</label>
          <select id="crop-aspect" style="width:100%; padding:6px; margin-top:6px;">
            <option value="NaN">Free</option>
            <option value="1">1:1</option>
            <option value="16/9">16:9</option>
            <option value="4/3">4:3</option>
            <option value="3/2">3:2</option>
          </select>
        </div>

        <div>
          <label style="display:block; font-size:13px; margin-top:8px;">Zoom</label>
          <input id="crop-zoom" type="range" min="0.1" max="3" step="0.01" value="1" style="width:100%;">
        </div>

        <div style="margin-top:8px;">
          <div style="font-size:13px; margin-bottom:6px;">Preview</div>
          <img id="crop-preview-canvas" class="crop-preview" alt="Preview" src="">
        </div>
      </div>
    </div>

    <div class="cm-footer">
      <div style="font-size:13px; color:#666;">Tip: use mouse or touch to move/resize crop box.</div>
      <div style="display:flex; gap:8px;">
        <button type="button" class="btn" id="crop-cancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="crop-apply">Apply Crop</button>
      </div>
    </div>
  </div>
</div>

<script>
/*
Inline cropper integration script.

- Uses cropper.js that was included above.
- Does NOT attempt to fetch or mutate saved image files; stores crop metadata JSON in hidden input:
  #crop-settings-<id> with name crop_settings[<id>]
- Updates preview thumbnail if possible.
- Preloads any existing crop JSON (if present) and applies it to the cropper when opened.
*/

(function () {
  'use strict';

  // Selectors / IDs used in markup
  var SET_CROP_BUTTON_SEL = '.btn-set-crop';
  var HIDDEN_INPUT_ID = function (id) { return 'crop-settings-' + id; };
  var PREVIEW_IMG_ID = function (id) { return 'crop-preview-' + id; };

  // Modal elements
  var overlay = document.getElementById('cropperModalOverlay');
  var cropperImage = document.getElementById('cropperImage');
  var applyBtn = document.getElementById('crop-apply');
  var cancelBtn = document.getElementById('crop-cancel');
  var closeBtn = document.getElementById('cropper-close');
  var rotateLeftBtn = document.getElementById('crop-rotate-left');
  var rotateRightBtn = document.getElementById('crop-rotate-right');
  var resetBtn = document.getElementById('crop-reset');
  var aspectSelect = document.getElementById('crop-aspect');
  var zoomRange = document.getElementById('crop-zoom');
  var previewCanvasImg = document.getElementById('crop-preview-canvas');

  var cropper = null;
  var currentImageId = null;
  var currentImageSrc = null;
  var pendingInitialCrop = null;

  // Utility: show modal
  function openModal() {
    overlay.style.display = 'flex';
    document.body.classList.add('cropper-modal-open');
  }

  function closeModal() {
    overlay.style.display = 'none';
    document.body.classList.remove('cropper-modal-open');

    // destroy cropper to free memory
    if (cropper) {
      try { cropper.destroy(); } catch (e) {}
      cropper = null;
    }

    // clear image src to free memory
    cropperImage.src = '';
    previewCanvasImg.src = '';
    currentImageId = null;
    currentImageSrc = null;
    pendingInitialCrop = null;
    // reset zoom control
    zoomRange.value = "1";
    aspectSelect.value = "NaN";
  }

  // Initialize Cropper on the image element once loaded
  function initCropper() {
    if (!cropperImage) return;

    // Destroy if existing
    if (cropper) {
      try { cropper.destroy(); } catch (e) {}
      cropper = null;
    }

    cropper = new Cropper(cropperImage, {
      viewMode: 1,
      autoCropArea: 0.8,
      responsive: true,
      background: true,
      movable: true,
      zoomable: true,
      rotatable: true,
      scalable: true,
      ready: function () {
        // Apply any pending initial crop settings if present
        if (pendingInitialCrop) {
          try {
            // set aspect ratio if width/height present
            if (pendingInitialCrop.width && pendingInitialCrop.height) {
              var ratio = pendingInitialCrop.width / pendingInitialCrop.height;
              cropper.setAspectRatio(ratio || NaN);
            }
            cropper.setData(pendingInitialCrop);
          } catch (e) {
            // ignore invalid data
            console.warn('Could not set initial crop data', e);
          }
        }
        // update preview
        updatePreview();
      },
      crop: function () {
        // update the small preview in modal while user manipulates
        updatePreviewDebounced();
      }
    });
  }

  // Update preview image element using getCroppedCanvas (small size)
  function updatePreview() {
    if (!cropper) return;
    try {
      var canvas = cropper.getCroppedCanvas({ width: 320, height: undefined });
      if (canvas) {
        previewCanvasImg.src = canvas.toDataURL('image/png');
      }
    } catch (e) {
      // likely CORS issue; silently ignore preview
      previewCanvasImg.src = '';
    }
  }

  // Debounce preview updates so it is not too heavy while dragging
  var previewUpdateTimeout = null;
  function updatePreviewDebounced() {
    if (previewUpdateTimeout) clearTimeout(previewUpdateTimeout);
    previewUpdateTimeout = setTimeout(updatePreview, 120);
  }

  // Apply crop: write JSON to hidden input and update thumbnail preview in list
  function applyCrop() {
    if (!cropper || !currentImageId) {
      closeModal();
      return;
    }

    try {
      var d = cropper.getData(true); // rounded values
      var imageData = cropper.getImageData ? cropper.getImageData() : {};
      var canvasData = cropper.getCanvasData ? cropper.getCanvasData() : {};

      var cropSettings = {
        x: d.x,
        y: d.y,
        width: d.width,
        height: d.height,
        rotate: d.rotate || 0,
        scaleX: d.scaleX || 1,
        scaleY: d.scaleY || 1,
        imageNaturalWidth: imageData.naturalWidth || null,
        imageNaturalHeight: imageData.naturalHeight || null,
        canvas: {
          width: canvasData.width || null,
          height: canvasData.height || null,
          left: canvasData.left || null,
          top: canvasData.top || null
        },
        saved_at: new Date().toISOString()
      };

      // Write JSON into hidden input
      var inputEl = document.getElementById(HIDDEN_INPUT_ID(currentImageId));
      if (inputEl) {
        inputEl.value = JSON.stringify(cropSettings);
      } else {
        console.warn('Hidden crop settings input not found for', currentImageId);
      }

      // Update the inline preview thumbnail for the image list
      try {
        var smallCanvas = cropper.getCroppedCanvas({ width: 160 });
        if (smallCanvas) {
          var previewEl = document.getElementById(PREVIEW_IMG_ID(currentImageId));
          if (previewEl) {
            previewEl.src = smallCanvas.toDataURL('image/png');
          }
        }
      } catch (e) {
        // preview may fail on cross-origin images
      }

    } catch (err) {
      console.error('Failed to read crop data', err);
    } finally {
      closeModal();
    }
  }

  // Helpers: rotate/zoom/reset/aspect
  function rotateLeft() { if (cropper) cropper.rotate(-90); }
  function rotateRight() { if (cropper) cropper.rotate(90); }
  function resetCrop() { if (cropper) cropper.reset(); }
  function setAspect(value) {
    if (!cropper) return;
    var a = parseFloat(value);
    if (isNaN(a)) cropper.setAspectRatio(NaN);
    else cropper.setAspectRatio(a);
  }
  function setZoom(value) {
    if (!cropper) return;
    try {
      // cropper.zoomTo sets zoom relative to image; value is slider 0.1..3
      cropper.zoomTo(parseFloat(value));
    } catch (e) {
      // ignore
    }
  }

  // Event wiring: buttons etc.
  function wireModalControls() {
    applyBtn.addEventListener('click', applyCrop);
    cancelBtn.addEventListener('click', function (e) { e.preventDefault(); closeModal(); });
    closeBtn.addEventListener('click', function (e) { e.preventDefault(); closeModal(); });
    rotateLeftBtn.addEventListener('click', function (e) { e.preventDefault(); rotateLeft(); });
    rotateRightBtn.addEventListener('click', function (e) { e.preventDefault(); rotateRight(); });
    resetBtn.addEventListener('click', function (e) { e.preventDefault(); resetCrop(); });
    aspectSelect.addEventListener('change', function (e) { setAspect(e.target.value); });
    zoomRange.addEventListener('input', function (e) { setZoom(e.target.value); });

    // Close modal when clicking overlay outside the dialog
    overlay.addEventListener('click', function (ev) {
      if (ev.target === overlay) {
        closeModal();
      }
    });

    // Close on ESC
    document.addEventListener('keydown', function (ev) {
      if (ev.key === 'Escape' && overlay.style.display === 'flex') {
        closeModal();
      }
    });

    // When cropperImage has loaded, init cropper
    cropperImage.addEventListener('load', function () {
      initCropper();
    });
  }

  // Attach click handler to all Set Crop buttons (delegated)
  function wireSetCropButtons() {
    document.addEventListener('click', function (ev) {
      var btn = ev.target.closest && ev.target.closest(SET_CROP_BUTTON_SEL);
      if (!btn) return;
      ev.preventDefault();

      currentImageId = btn.getAttribute('data-image-id');
      currentImageSrc = btn.getAttribute('data-image-src');

      if (!currentImageId || !currentImageSrc) {
        console.warn('Set Crop button missing data-image-id or data-image-src', btn);
        return;
      }

      // If there is existing crop JSON in the hidden input, try to parse and apply it after cropper init
      pendingInitialCrop = null;
      var existingInput = document.getElementById(HIDDEN_INPUT_ID(currentImageId));
      if (existingInput && existingInput.value) {
        try {
          var parsed = JSON.parse(existingInput.value);
          // Ensure numeric fields exist (cropper.setData expects numeric props)
          if (parsed && typeof parsed === 'object') {
            pendingInitialCrop = {
              x: Number(parsed.x || 0),
              y: Number(parsed.y || 0),
              width: Number(parsed.width || 0),
              height: Number(parsed.height || 0),
              rotate: Number(parsed.rotate || 0),
              scaleX: Number(parsed.scaleX || 1),
              scaleY: Number(parsed.scaleY || 1)
            };
          }
        } catch (e) {
          // invalid JSON - ignore
        }
      }

      // Load the image into modal. Append timestamp to bust cache if needed.
      var srcNoCache = currentImageSrc + (currentImageSrc.indexOf('?') === -1 ? '?_=' : '&_=' ) + Date.now();
      cropperImage.src = srcNoCache;

      // Set default controls
      aspectSelect.value = "NaN";
      zoomRange.value = "1";

      // Open modal (cropper will init when image load fires)
      openModal();
    });
  }

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', function () {
    wireModalControls();
    wireSetCropButtons();
  });

})();
</script>